name: Jira Codex Implementation

on:
  workflow_dispatch:
    inputs:
      issue_key:
        description: "Jira issue key"
        required: true
        type: string
      issue_summary:
        description: "Jira issue summary"
        required: true
        type: string
      issue_description:
        description: "Jira issue description"
        required: true
        type: string

jobs:
  implement:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (gives Codex repo context)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install codex
        run: |
          npm i -g @openai/codex

      - name: Login to codex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Login to codex using API key from stdin
          echo "$OPENAI_API_KEY" | codex login --with-api-key

      - name: Run codex implementation
        id: codex
        env:
          ISSUE_KEY: ${{ github.event.inputs.issue_key }}
          ISSUE_SUMMARY: ${{ github.event.inputs.issue_summary }}
          ISSUE_DESCRIPTION: ${{ github.event.inputs.issue_description }}
          CI: true
        run: |
          # Create a comprehensive prompt for codex (kept in a file to preserve formatting)
          cat <<'EOF' > /tmp/codex-prompt.txt
          Issue: $ISSUE_KEY - $ISSUE_SUMMARY

          $ISSUE_DESCRIPTION
          EOF

          # Run codex cloud exec with environment ID. Because the repo is checked out,
          # codex cloud has the repository context available for the run.
          # Capture the output which includes the task link
          OUTPUT=$(codex cloud exec --env "Doc-rag-agent" "$(cat /tmp/codex-prompt.txt)" 2>&1)

          # Extract the task link from the output (looks like https://chatgpt.com/codex/tasks/task_...)
          TASK_LINK=$(echo "$OUTPUT" | grep -o 'https://chatgpt.com/codex/tasks/[^[:space:]]*' | head -1)

          # Display the output
          echo "$OUTPUT"

          # Save the task link as an output
          if [ -n "$TASK_LINK" ]; then
            echo "task_link=$TASK_LINK" >> $GITHUB_OUTPUT
            echo "::notice::Codex task link: $TASK_LINK"
          fi
