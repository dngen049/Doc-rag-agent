name: Jira Codex Implementation

on:
  workflow_dispatch:
    inputs:
      issue_key:
        description: "Jira issue key"
        required: true
        type: string
      issue_summary:
        description: "Jira issue summary"
        required: true
        type: string
      issue_description:
        description: "Jira issue description"
        required: true
        type: string

jobs:
  implement:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (gives Codex repo context)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install codex
        run: |
          npm i -g @openai/codex

      - name: Login to codex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Login to codex using API key from stdin
          echo "$OPENAI_API_KEY" | codex login --with-api-key

      - name: Run codex implementation
        id: codex
        env:
          ISSUE_KEY: ${{ github.event.inputs.issue_key }}
          ISSUE_SUMMARY: ${{ github.event.inputs.issue_summary }}
          ISSUE_DESCRIPTION: ${{ github.event.inputs.issue_description }}
          CI: true
        run: |
          # Build the prompt inline to keep formatting without writing a file
          PROMPT=$(printf "Issue: %s - %s\n\n%s\n" "$ISSUE_KEY" "$ISSUE_SUMMARY" "$ISSUE_DESCRIPTION")

          # Run codex cloud exec with environment ID. Because the repo is checked out,
          # codex cloud has the repository context available for the run.
          codex cloud exec --env Doc-rag-agent "$PROMPT"
